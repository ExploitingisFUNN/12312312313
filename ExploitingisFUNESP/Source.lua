--[[
unnamed esp
author: binary32
]] -- 

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

local Color3_fromRGB = Color3.fromRGB
local Vector2_new = Vector2.new
local Vector3_new = Vector3.new
local math_floor = math.floor
local math_clamp = math.clamp
local math_min = math.min
local math_max = math.max
local math_huge = math.huge
local table_insert = table.insert
local IsA = game.IsA

local CobaltESP = {}
CobaltESP.__index = CobaltESP

CobaltESP.Settings = {
    Enabled = true,
    LocalPlayer = true,

    Font = "Tahoma",
    FontSize = 12,
    FontType = "lowercase",

    MaxDistance = 1000,
    RefreshRate = 60,

    BoundingBox = {
        Enabled = true,
        DynamicBox = true,
        IncludeAccessories = false,

        Rotation = 90,
        Color = {Color3_fromRGB(216, 126, 157), Color3_fromRGB(216, 126, 157)},
        Transparency = {0, 0},

        Glow = {
            Enabled = true,
            Rotation = 90,
            Color = {Color3_fromRGB(216, 126, 157), Color3_fromRGB(216, 126, 157)},
            Transparency = {0.75, 0.75},
        },

        Fill = {
            Enabled = true,
            Rotation = 90,
            Color = {Color3_fromRGB(216, 126, 157), Color3_fromRGB(216, 126, 157)},
            Transparency = {1, 0.5},
        },
    },

    Bars = {
        HealthBar = {
            Enabled = true,
            Position = "Left",
            Color = {Color3_fromRGB(131, 245, 78), Color3_fromRGB(255, 255, 0), Color3_fromRGB(252, 71, 77)},

            Type = function(Player)
                if not IsA(Player, "Player") then return end

                local Character = Player.Character
                local Humanoid = Character.Humanoid

                return Humanoid.Health / Humanoid.MaxHealth
            end,

            Text = {
                Enabled = true,
                FollowBar = false,
                Ending = "HP",
                Position = "Left",
                Color = Color3_fromRGB(255, 255, 255),
                Transparency = 0,

                Type = function(Player)
                    if not IsA(Player, "Player") then return end

                    local Character = Player.Character
                    local Humanoid = Character.Humanoid

                    return Humanoid.Health, Humanoid.Health ~= Humanoid.MaxHealth
                end,
            },
        },

        ArmorBar = {
            Enabled = false,
            Position = "Bottom",
            Color = {Color3_fromRGB(52, 131, 235), Color3_fromRGB(52, 131, 235), Color3_fromRGB(52, 131, 235)},

            Type = function(Player)
                if not IsA(Player, "Player") then return end

                local Character = Player.Character
                local Humanoid = Character.Humanoid

                return Humanoid.Health / Humanoid.MaxHealth
            end,

            Text = {
                Enabled = true,
                FollowBar = true,
                Ending = "%",
                Position = "Left",
                Color = Color3_fromRGB(255, 255, 255),
                Transparency = 0,

                Type = function(Player)
                    if not IsA(Player, "Player") then return end

                    local Character = Player.Character
                    local Humanoid = Character.Humanoid

                    return Humanoid.Health, Humanoid.Health ~= Humanoid.MaxHealth
                end,
            },
        },
    },

    Name = {
        Enabled = true,
        UseDisplay = true,
        Position = "Top",
        Color = Color3_fromRGB(255, 255, 255),
        Transparency = 0,
    },

    Distance = {
        Enabled = true,
        Ending = "st",
        Position = "Bottom",
        Color = Color3_fromRGB(255, 255, 255),
        Transparency = 0,
    },

    Weapon = {
        Enabled = true,
        Position = "Bottom",
        Color = Color3_fromRGB(255, 255, 255),
        Transparency = 0,
    },

    Flags = {
        Enabled = true,
        Position = "Right",
        Color = Color3_fromRGB(255, 255, 255),
        Transparency = 0,

        Type = function(Player)
            local Flags = {}

            if not IsA(Player, "Player") then return Flags end

            local Character = Player.Character
            local Humanoid = Character.Humanoid
            if not Humanoid then return end

            if Humanoid.MoveDirection.Magnitude > 0 then
                table_insert(Flags, "moving")
            end

            if Humanoid.Jump then
                table_insert(Flags, "jumping")
            end

            return Flags
        end
    },
}

CobaltESP.Objects = {}
CobaltESP.Connections = {}

local FontMap = {
    ["UI"] = 0,
    ["System"] = 1,
    ["Plex"] = 2,
    ["Monospace"] = 3,
    ["Tahoma"] = 2,
}

local function GetFont(FontName)
    return FontMap[FontName] or 2
end

local function FormatText(Text, FontType)
    if FontType == "uppercase" then
        return string.upper(Text)
    elseif FontType == "lowercase" then
        return string.lower(Text)
    end
    return Text
end

local function LerpColor(Color1, Color2, Alpha)
    return Color3.new(
        Color1.R + (Color2.R - Color1.R) * Alpha,
        Color1.G + (Color2.G - Color1.G) * Alpha,
        Color1.B + (Color2.B - Color1.B) * Alpha
    )
end

local function GetHealthColor(Ratio, Colors)
    if Ratio > 0.5 then
        return LerpColor(Colors[2], Colors[1], (Ratio - 0.5) * 2)
    else
        return LerpColor(Colors[3], Colors[2], Ratio * 2)
    end
end

local function LerpTransparency(Trans1, Trans2, Alpha)
    return Trans1 + (Trans2 - Trans1) * Alpha
end

local ESPObject = {}
ESPObject.__index = ESPObject

function ESPObject.New(Target, Options)
    local self = setmetatable({}, ESPObject)

    self.Target = Target
    self.Player = nil
    self.Character = nil
    self.Humanoid = nil
    self.RootPart = nil
    self.IsObject = false
    self.Options = Options or {}
    self.CustomName = self.Options.Name
    self.CustomColor = self.Options.Color

    if typeof(Target) == "Instance" then
        if Target:IsA("Player") then
            self.Player = Target
            self.Character = Target.Character
            if self.Character then
                self.Humanoid = self.Character:FindFirstChildOfClass("Humanoid")
                self.RootPart = self.Character:FindFirstChild("HumanoidRootPart") or self.Character:FindFirstChild("Torso")
            end
        elseif Target:IsA("Model") then
            self.Character = Target
            self.Player = Players:GetPlayerFromCharacter(Target)
            self.Humanoid = Target:FindFirstChildOfClass("Humanoid")
            self.RootPart = Target:FindFirstChild("HumanoidRootPart") or Target:FindFirstChild("Torso") or Target.PrimaryPart or Target:FindFirstChildWhichIsA("BasePart")
            if not self.Humanoid then
                self.IsObject = true
            end
        elseif Target:IsA("BasePart") then
            self.IsObject = true
            self.RootPart = Target
            self.Character = Target
        end
    end

    self.Drawings = {
        BoxOutline = Drawing.new("Square"),
        BoxInline = Drawing.new("Square"),
        BoxFill = Drawing.new("Square"),
        BoxGlow = Drawing.new("Square"),

        HealthBarOutline = Drawing.new("Square"),
        HealthBarBackground = Drawing.new("Square"),
        HealthBarFill = Drawing.new("Square"),
        HealthText = Drawing.new("Text"),

        ArmorBarOutline = Drawing.new("Square"),
        ArmorBarBackground = Drawing.new("Square"),
        ArmorBarFill = Drawing.new("Square"),
        ArmorText = Drawing.new("Text"),

        NameText = Drawing.new("Text"),
        DistanceText = Drawing.new("Text"),
        WeaponText = Drawing.new("Text"),
        FlagsText = Drawing.new("Text"),
    }

    self:InitializeDrawings()

    return self
end

function ESPObject:InitializeDrawings()
    local Settings = CobaltESP.Settings

    self.Drawings.BoxOutline.Thickness = 3
    self.Drawings.BoxOutline.Filled = false
    self.Drawings.BoxOutline.Color = Color3_fromRGB(0, 0, 0)
    self.Drawings.BoxOutline.Visible = false

    self.Drawings.BoxInline.Thickness = 1
    self.Drawings.BoxInline.Filled = false
    self.Drawings.BoxInline.Visible = false

    self.Drawings.BoxFill.Thickness = 1
    self.Drawings.BoxFill.Filled = true
    self.Drawings.BoxFill.Visible = false

    self.Drawings.BoxGlow.Thickness = 5
    self.Drawings.BoxGlow.Filled = false
    self.Drawings.BoxGlow.Visible = false

    self.Drawings.HealthBarOutline.Thickness = 1
    self.Drawings.HealthBarOutline.Filled = true
    self.Drawings.HealthBarOutline.Color = Color3_fromRGB(0, 0, 0)
    self.Drawings.HealthBarOutline.Visible = false

    self.Drawings.HealthBarBackground.Thickness = 1
    self.Drawings.HealthBarBackground.Filled = true
    self.Drawings.HealthBarBackground.Color = Color3_fromRGB(30, 30, 30)
    self.Drawings.HealthBarBackground.Visible = false

    self.Drawings.HealthBarFill.Thickness = 1
    self.Drawings.HealthBarFill.Filled = true
    self.Drawings.HealthBarFill.Visible = false

    self.Drawings.HealthText.Center = false
    self.Drawings.HealthText.Outline = true
    self.Drawings.HealthText.OutlineColor = Color3_fromRGB(0, 0, 0)
    self.Drawings.HealthText.Font = GetFont(Settings.Font)
    self.Drawings.HealthText.Size = Settings.FontSize
    self.Drawings.HealthText.Visible = false

    self.Drawings.ArmorBarOutline.Thickness = 1
    self.Drawings.ArmorBarOutline.Filled = true
    self.Drawings.ArmorBarOutline.Color = Color3_fromRGB(0, 0, 0)
    self.Drawings.ArmorBarOutline.Visible = false

    self.Drawings.ArmorBarBackground.Thickness = 1
    self.Drawings.ArmorBarBackground.Filled = true
    self.Drawings.ArmorBarBackground.Color = Color3_fromRGB(30, 30, 30)
    self.Drawings.ArmorBarBackground.Visible = false

    self.Drawings.ArmorBarFill.Thickness = 1
    self.Drawings.ArmorBarFill.Filled = true
    self.Drawings.ArmorBarFill.Visible = false

    self.Drawings.ArmorText.Center = true
    self.Drawings.ArmorText.Outline = true
    self.Drawings.ArmorText.OutlineColor = Color3_fromRGB(0, 0, 0)
    self.Drawings.ArmorText.Font = GetFont(Settings.Font)
    self.Drawings.ArmorText.Size = Settings.FontSize
    self.Drawings.ArmorText.Visible = false

    self.Drawings.NameText.Center = true
    self.Drawings.NameText.Outline = true
    self.Drawings.NameText.OutlineColor = Color3_fromRGB(0, 0, 0)
    self.Drawings.NameText.Font = GetFont(Settings.Font)
    self.Drawings.NameText.Size = Settings.FontSize
    self.Drawings.NameText.Visible = false

    self.Drawings.DistanceText.Center = true
    self.Drawings.DistanceText.Outline = true
    self.Drawings.DistanceText.OutlineColor = Color3_fromRGB(0, 0, 0)
    self.Drawings.DistanceText.Font = GetFont(Settings.Font)
    self.Drawings.DistanceText.Size = Settings.FontSize
    self.Drawings.DistanceText.Visible = false

    self.Drawings.WeaponText.Center = true
    self.Drawings.WeaponText.Outline = true
    self.Drawings.WeaponText.OutlineColor = Color3_fromRGB(0, 0, 0)
    self.Drawings.WeaponText.Font = GetFont(Settings.Font)
    self.Drawings.WeaponText.Size = Settings.FontSize
    self.Drawings.WeaponText.Visible = false

    self.Drawings.FlagsText.Center = false
    self.Drawings.FlagsText.Outline = true
    self.Drawings.FlagsText.OutlineColor = Color3_fromRGB(0, 0, 0)
    self.Drawings.FlagsText.Font = GetFont(Settings.Font)
    self.Drawings.FlagsText.Size = Settings.FontSize
    self.Drawings.FlagsText.Visible = false
end

function ESPObject:GetBoundingBox()
    local Settings = CobaltESP.Settings
    local Character = self.Character

    if not Character then return nil, nil, false end

    local Min = Vector2_new(math_huge, math_huge)
    local Max = Vector2_new(-math_huge, -math_huge)
    local OnScreen = false

    local Parts = {}

    if Character:IsA("BasePart") then
        table_insert(Parts, Character)
    else
        for _, Part in pairs(Character:GetDescendants()) do
            if Part:IsA("BasePart") then
                table_insert(Parts, Part)
            elseif Part:IsA("Accessory") and Settings.BoundingBox.IncludeAccessories then
                local Handle = Part:FindFirstChild("Handle")
                if Handle and Handle:IsA("BasePart") then
                    table_insert(Parts, Handle)
                end
            end
        end
        
        if #Parts == 0 then
            for _, Part in pairs(Character:GetChildren()) do
                if Part:IsA("BasePart") then
                    table_insert(Parts, Part)
                end
            end
        end
    end

    for _, Part in pairs(Parts) do
        local Size = Part.Size / 2
        local CF = Part.CFrame

        local Corners = {
            Vector3_new(Size.X, Size.Y, Size.Z),
            Vector3_new(-Size.X, Size.Y, Size.Z),
            Vector3_new(Size.X, -Size.Y, Size.Z),
            Vector3_new(-Size.X, -Size.Y, Size.Z),
            Vector3_new(Size.X, Size.Y, -Size.Z),
            Vector3_new(-Size.X, Size.Y, -Size.Z),
            Vector3_new(Size.X, -Size.Y, -Size.Z),
            Vector3_new(-Size.X, -Size.Y, -Size.Z),
        }

        for _, Corner in pairs(Corners) do
            local WorldPos = CF:PointToWorldSpace(Corner)
            local ScreenPos, Visible = Camera:WorldToViewportPoint(WorldPos)

            if Visible then
                local Vec2Pos = Vector2_new(ScreenPos.X, ScreenPos.Y)
                Min = Vector2_new(math_min(Min.X, Vec2Pos.X), math_min(Min.Y, Vec2Pos.Y))
                Max = Vector2_new(math_max(Max.X, Vec2Pos.X), math_max(Max.Y, Vec2Pos.Y))
                OnScreen = true
            end
        end
    end

    return Min, Max, OnScreen
end

function ESPObject:GetStaticBoundingBox()
    local Character = self.Character
    local RootPart = self.RootPart
    local Humanoid = self.Humanoid

    if not (Character and RootPart and Humanoid) then return nil, nil, false end

    local RootPos, Visible = Camera:WorldToViewportPoint(RootPart.Position)
    if not Visible then return nil, nil, false end

    local ScaleFactor = 1 / (RootPos.Z * math.tan(math.rad(Camera.FieldOfView / 2)) * 2) * 1000

    local HipHeight = Humanoid.HipHeight
    local Height = (Humanoid.RigType == Enum.HumanoidRigType.R15) and 5.2 or 5
    Height = Height + HipHeight

    local BoxHeight = Height * ScaleFactor
    local BoxWidth = BoxHeight * 0.5

    local CenterX = RootPos.X
    local CenterY = RootPos.Y

    local Min = Vector2_new(CenterX - BoxWidth / 2, CenterY - BoxHeight / 2)
    local Max = Vector2_new(CenterX + BoxWidth / 2, CenterY + BoxHeight / 2)

    return Min, Max, true
end

function ESPObject:GetDistance()
    local RootPart = self.RootPart
    if not RootPart then return math_huge end

    return (Camera.CFrame.Position - RootPart.Position).Magnitude
end

function ESPObject:GetWeapon()
    local Character = self.Character
    if not Character then return "none" end

    local Tool = Character:FindFirstChildOfClass("Tool")
    if Tool then
        return Tool.Name
    end

    return "none"
end

function ESPObject:Update()
    local Settings = CobaltESP.Settings

    if self.Player then
        self.Character = self.Player.Character
        if self.Character then
            self.Humanoid = self.Character:FindFirstChildOfClass("Humanoid")
            self.RootPart = self.Character:FindFirstChild("HumanoidRootPart") or self.Character:FindFirstChild("Torso")
        end
    elseif self.IsObject and self.Target then
        if self.Target:IsA("BasePart") then
            self.RootPart = self.Target
            self.Character = self.Target
        elseif self.Target:IsA("Model") then
            self.Character = self.Target
            self.RootPart = self.Target.PrimaryPart or self.Target:FindFirstChildWhichIsA("BasePart")
        end
    end

    if not Settings.Enabled then
        self:Hide()
        return
    end

    if not self.Character or not self.RootPart then
        self:Hide()
        return
    end

    if not self.IsObject and self.Humanoid and self.Humanoid.Health <= 0 then
        self:Hide()
        return
    end

    local Distance = self:GetDistance()
    if Distance > Settings.MaxDistance then
        self:Hide()
        return
    end

    if not Settings.LocalPlayer and self.Player == LocalPlayer then
        self:Hide()
        return
    end

    local Min, Max, OnScreen

    if Settings.BoundingBox.DynamicBox then
        Min, Max, OnScreen = self:GetBoundingBox()
    else
        if self.IsObject then
            Min, Max, OnScreen = self:GetBoundingBox()
        else
            Min, Max, OnScreen = self:GetStaticBoundingBox()
        end
    end

    if not OnScreen or not Min or not Max then
        self:Hide()
        return
    end

    local BoxWidth = Max.X - Min.X
    local BoxHeight = Max.Y - Min.Y
    local CenterX = (Min.X + Max.X) / 2
    local HeightRatio = BoxHeight > 0 and math_clamp((Max.Y - Min.Y) / BoxHeight, 0, 1) or 0

    self:UpdateBoundingBox(Min, Max, HeightRatio)
    
    if self.IsObject then
        self.Drawings.HealthBarOutline.Visible = false
        self.Drawings.HealthBarBackground.Visible = false
        self.Drawings.HealthBarFill.Visible = false
        self.Drawings.HealthText.Visible = false
        self.Drawings.ArmorBarOutline.Visible = false
        self.Drawings.ArmorBarBackground.Visible = false
        self.Drawings.ArmorBarFill.Visible = false
        self.Drawings.ArmorText.Visible = false
    else
        self:UpdateHealthBar(Min, Max)
        self:UpdateArmorBar(Min, Max)
    end
    
    self:UpdateName(Min, Max, CenterX)
    self:UpdateDistance(Min, Max, CenterX, Distance)
    
    if self.IsObject then
        self.Drawings.WeaponText.Visible = false
        self.Drawings.FlagsText.Visible = false
    else
        self:UpdateWeapon(Min, Max, CenterX)
        self:UpdateFlags(Min, Max)
    end
end

function ESPObject:UpdateBoundingBox(Min, Max, HeightRatio)
    local Settings = CobaltESP.Settings.BoundingBox

    if not Settings.Enabled then
        self.Drawings.BoxOutline.Visible = false
        self.Drawings.BoxInline.Visible = false
        self.Drawings.BoxFill.Visible = false
        self.Drawings.BoxGlow.Visible = false
        return
    end

    local BoxColor
    if self.CustomColor then
        BoxColor = self.CustomColor
    else
        BoxColor = LerpColor(Settings.Color[1], Settings.Color[2], HeightRatio)
    end
    local BoxTransparency = LerpTransparency(Settings.Transparency[1], Settings.Transparency[2], HeightRatio)

    self.Drawings.BoxOutline.Position = Min - Vector2_new(1, 1)
    self.Drawings.BoxOutline.Size = (Max - Min) + Vector2_new(2, 2)
    self.Drawings.BoxOutline.Transparency = 1 - BoxTransparency
    self.Drawings.BoxOutline.Visible = true

    self.Drawings.BoxInline.Position = Min
    self.Drawings.BoxInline.Size = Max - Min
    self.Drawings.BoxInline.Color = BoxColor
    self.Drawings.BoxInline.Transparency = 1 - BoxTransparency
    self.Drawings.BoxInline.Visible = true

    if Settings.Fill.Enabled then
        local FillColor
        if self.CustomColor then
            FillColor = self.CustomColor
        else
            FillColor = LerpColor(Settings.Fill.Color[1], Settings.Fill.Color[2], HeightRatio)
        end
        local FillTransparency = LerpTransparency(Settings.Fill.Transparency[1], Settings.Fill.Transparency[2], HeightRatio)

        self.Drawings.BoxFill.Position = Min
        self.Drawings.BoxFill.Size = Max - Min
        self.Drawings.BoxFill.Color = FillColor
        self.Drawings.BoxFill.Transparency = 1 - FillTransparency
        self.Drawings.BoxFill.Visible = true
    else
        self.Drawings.BoxFill.Visible = false
    end

    if Settings.Glow.Enabled then
        local GlowColor
        if self.CustomColor then
            GlowColor = self.CustomColor
        else
            GlowColor = LerpColor(Settings.Glow.Color[1], Settings.Glow.Color[2], HeightRatio)
        end
        local GlowTransparency = LerpTransparency(Settings.Glow.Transparency[1], Settings.Glow.Transparency[2], HeightRatio)

        self.Drawings.BoxGlow.Position = Min - Vector2_new(3, 3)
        self.Drawings.BoxGlow.Size = (Max - Min) + Vector2_new(6, 6)
        self.Drawings.BoxGlow.Color = GlowColor
        self.Drawings.BoxGlow.Transparency = 1 - GlowTransparency
        self.Drawings.BoxGlow.Visible = true
    else
        self.Drawings.BoxGlow.Visible = false
    end
end

function ESPObject:UpdateHealthBar(Min, Max)
    local Settings = CobaltESP.Settings.Bars.HealthBar

    if not Settings.Enabled then
        self.Drawings.HealthBarOutline.Visible = false
        self.Drawings.HealthBarBackground.Visible = false
        self.Drawings.HealthBarFill.Visible = false
        self.Drawings.HealthText.Visible = false
        return
    end

    local HealthRatio = Settings.Type(self.Player or self.Character)
    if not HealthRatio then
        self.Drawings.HealthBarOutline.Visible = false
        self.Drawings.HealthBarBackground.Visible = false
        self.Drawings.HealthBarFill.Visible = false
        self.Drawings.HealthText.Visible = false
        return
    end

    HealthRatio = math_clamp(HealthRatio, 0, 1)

    local BoxHeight = Max.Y - Min.Y
    local BarWidth = 2
    local BarHeight = BoxHeight
    local Padding = 4

    local BarX, BarY

    if Settings.Position == "Left" then
        BarX = Min.X - Padding - BarWidth
        BarY = Min.Y
    elseif Settings.Position == "Right" then
        BarX = Max.X + Padding
        BarY = Min.Y
    end

    self.Drawings.HealthBarOutline.Position = Vector2_new(BarX - 1, BarY - 1)
    self.Drawings.HealthBarOutline.Size = Vector2_new(BarWidth + 2, BarHeight + 2)
    self.Drawings.HealthBarOutline.Visible = true

    self.Drawings.HealthBarBackground.Position = Vector2_new(BarX, BarY)
    self.Drawings.HealthBarBackground.Size = Vector2_new(BarWidth, BarHeight)
    self.Drawings.HealthBarBackground.Visible = true

    local FillHeight = BarHeight * HealthRatio
    local HealthColor = GetHealthColor(HealthRatio, Settings.Color)

    self.Drawings.HealthBarFill.Position = Vector2_new(BarX, BarY + (BarHeight - FillHeight))
    self.Drawings.HealthBarFill.Size = Vector2_new(BarWidth, FillHeight)
    self.Drawings.HealthBarFill.Color = HealthColor
    self.Drawings.HealthBarFill.Visible = true

    if Settings.Text.Enabled then
        local TextValue, ShouldShow = Settings.Text.Type(self.Player or self.Character)

        if TextValue then
            local TextStr = FormatText(math_floor(TextValue) .. Settings.Text.Ending, CobaltESP.Settings.FontType)

            self.Drawings.HealthText.Text = TextStr
            self.Drawings.HealthText.Color = Settings.Text.Color
            self.Drawings.HealthText.Transparency = 1 - Settings.Text.Transparency

            if Settings.Text.FollowBar then
                local TextY = BarY + (BarHeight - FillHeight) - 6
                self.Drawings.HealthText.Position = Vector2_new(BarX - 2, TextY)
                self.Drawings.HealthText.Visible = ShouldShow or false
            else
                local TextY = BarY + (BarHeight / 2) - 6
                if Settings.Text.Position == "Left" then
                    self.Drawings.HealthText.Position = Vector2_new(BarX - 25, TextY)
                else
                    self.Drawings.HealthText.Position = Vector2_new(BarX + BarWidth + 2, TextY)
                end
                self.Drawings.HealthText.Visible = true
            end
        else
            self.Drawings.HealthText.Visible = false
        end
    else
        self.Drawings.HealthText.Visible = false
    end
end

function ESPObject:UpdateArmorBar(Min, Max)
    local Settings = CobaltESP.Settings.Bars.ArmorBar

    if not Settings.Enabled then
        self.Drawings.ArmorBarOutline.Visible = false
        self.Drawings.ArmorBarBackground.Visible = false
        self.Drawings.ArmorBarFill.Visible = false
        self.Drawings.ArmorText.Visible = false
        return
    end

    local ArmorRatio = Settings.Type(self.Player or self.Character)
    if not ArmorRatio then
        self.Drawings.ArmorBarOutline.Visible = false
        self.Drawings.ArmorBarBackground.Visible = false
        self.Drawings.ArmorBarFill.Visible = false
        self.Drawings.ArmorText.Visible = false
        return
    end

    ArmorRatio = math_clamp(ArmorRatio, 0, 1)

    local BoxWidth = Max.X - Min.X
    local BarWidth = BoxWidth
    local BarHeight = 2
    local Padding = 4

    local BarX = Min.X
    local BarY = Max.Y + Padding

    self.Drawings.ArmorBarOutline.Position = Vector2_new(BarX - 1, BarY - 1)
    self.Drawings.ArmorBarOutline.Size = Vector2_new(BarWidth + 2, BarHeight + 2)
    self.Drawings.ArmorBarOutline.Visible = true

    self.Drawings.ArmorBarBackground.Position = Vector2_new(BarX, BarY)
    self.Drawings.ArmorBarBackground.Size = Vector2_new(BarWidth, BarHeight)
    self.Drawings.ArmorBarBackground.Visible = true

    local FillWidth = BarWidth * ArmorRatio
    local ArmorColor = GetHealthColor(ArmorRatio, Settings.Color)

    self.Drawings.ArmorBarFill.Position = Vector2_new(BarX, BarY)
    self.Drawings.ArmorBarFill.Size = Vector2_new(FillWidth, BarHeight)
    self.Drawings.ArmorBarFill.Color = ArmorColor
    self.Drawings.ArmorBarFill.Visible = true

    if Settings.Text.Enabled then
        local TextValue, ShouldShow = Settings.Text.Type(self.Player or self.Character)

        if TextValue then
            local TextStr = FormatText(math_floor(TextValue) .. Settings.Text.Ending, CobaltESP.Settings.FontType)

            self.Drawings.ArmorText.Text = TextStr
            self.Drawings.ArmorText.Color = Settings.Text.Color
            self.Drawings.ArmorText.Transparency = 1 - Settings.Text.Transparency

            if Settings.Text.FollowBar then
                self.Drawings.ArmorText.Position = Vector2_new(BarX + FillWidth, BarY + BarHeight + 2)
                self.Drawings.ArmorText.Visible = ShouldShow or false
            else
                self.Drawings.ArmorText.Position = Vector2_new(BarX + BarWidth / 2, BarY + BarHeight + 2)
                self.Drawings.ArmorText.Visible = true
            end
        else
            self.Drawings.ArmorText.Visible = false
        end
    else
        self.Drawings.ArmorText.Visible = false
    end
end

function ESPObject:UpdateName(Min, Max, CenterX)
    local Settings = CobaltESP.Settings.Name

    if not Settings.Enabled then
        self.Drawings.NameText.Visible = false
        return
    end

    local Name = ""

    if self.CustomName then
        Name = self.CustomName
    elseif self.Player then
        Name = Settings.UseDisplay and self.Player.DisplayName or self.Player.Name
    elseif self.Character then
        Name = self.Character.Name
    end

    Name = FormatText(Name, CobaltESP.Settings.FontType)

    local TextY
    if Settings.Position == "Top" then
        TextY = Min.Y - CobaltESP.Settings.FontSize - 2
    else
        TextY = Max.Y + 2
    end

    self.Drawings.NameText.Text = Name
    self.Drawings.NameText.Position = Vector2_new(CenterX, TextY)
    self.Drawings.NameText.Color = self.CustomColor or Settings.Color
    self.Drawings.NameText.Transparency = 1 - Settings.Transparency
    self.Drawings.NameText.Visible = true
end

function ESPObject:UpdateDistance(Min, Max, CenterX, Distance)
    local Settings = CobaltESP.Settings.Distance

    if not Settings.Enabled then
        self.Drawings.DistanceText.Visible = false
        return
    end

    local DistanceStr = FormatText(math_floor(Distance) .. Settings.Ending, CobaltESP.Settings.FontType)

    local TextY
    local OffsetY = 0

    if CobaltESP.Settings.Bars.ArmorBar.Enabled and not self.IsObject then
        OffsetY = OffsetY + 8
    end

    if Settings.Position == "Top" then
        TextY = Min.Y - CobaltESP.Settings.FontSize - 2 - 14
    else
        TextY = Max.Y + 2 + OffsetY
    end

    self.Drawings.DistanceText.Text = DistanceStr
    self.Drawings.DistanceText.Position = Vector2_new(CenterX, TextY)
    self.Drawings.DistanceText.Color = self.CustomColor or Settings.Color
    self.Drawings.DistanceText.Transparency = 1 - Settings.Transparency
    self.Drawings.DistanceText.Visible = true
end

function ESPObject:UpdateWeapon(Min, Max, CenterX)
    local Settings = CobaltESP.Settings.Weapon

    if not Settings.Enabled then
        self.Drawings.WeaponText.Visible = false
        return
    end

    local Weapon = self:GetWeapon()
    Weapon = FormatText(Weapon, CobaltESP.Settings.FontType)

    local TextY
    local OffsetY = 0

    if CobaltESP.Settings.Distance.Enabled then
        OffsetY = OffsetY + 14
    end

    if CobaltESP.Settings.Bars.ArmorBar.Enabled then
        OffsetY = OffsetY + 8
    end

    if Settings.Position == "Top" then
        TextY = Min.Y - CobaltESP.Settings.FontSize - 2 - OffsetY
    else
        TextY = Max.Y + 2 + OffsetY
    end

    self.Drawings.WeaponText.Text = Weapon
    self.Drawings.WeaponText.Position = Vector2_new(CenterX, TextY)
    self.Drawings.WeaponText.Color = Settings.Color
    self.Drawings.WeaponText.Transparency = 1 - Settings.Transparency
    self.Drawings.WeaponText.Visible = true
end

function ESPObject:UpdateFlags(Min, Max)
    local Settings = CobaltESP.Settings.Flags

    if not Settings.Enabled then
        self.Drawings.FlagsText.Visible = false
        return
    end

    local Flags = Settings.Type(self.Player or self.Character)
    if not Flags or #Flags == 0 then
        self.Drawings.FlagsText.Visible = false
        return
    end

    local FlagsStr = ""
    for i, Flag in pairs(Flags) do
        FlagsStr = FlagsStr .. FormatText(Flag, CobaltESP.Settings.FontType)
        if i < #Flags then
            FlagsStr = FlagsStr .. "\n"
        end
    end

    local TextX, TextY

    if Settings.Position == "Right" then
        TextX = Max.X + 4
        TextY = Min.Y
    elseif Settings.Position == "Left" then
        TextX = Min.X - 50
        TextY = Min.Y
    end

    self.Drawings.FlagsText.Text = FlagsStr
    self.Drawings.FlagsText.Position = Vector2_new(TextX, TextY)
    self.Drawings.FlagsText.Color = Settings.Color
    self.Drawings.FlagsText.Transparency = 1 - Settings.Transparency
    self.Drawings.FlagsText.Visible = true
end

function ESPObject:Hide()
    for _, Drawing in pairs(self.Drawings) do
        Drawing.Visible = false
    end
end

function ESPObject:Destroy()
    for _, Drawing in pairs(self.Drawings) do
        Drawing:Remove()
    end
    self.Drawings = nil
end

function CobaltESP:Add(Target, Options)
    if self.Objects[Target] then return self.Objects[Target] end

    local Object = ESPObject.New(Target, Options)
    self.Objects[Target] = Object

    return Object
end

function CobaltESP:AddModel(Model, Options)
    if not Model or not Model:IsA("Model") then return nil end
    return self:Add(Model, Options)
end

function CobaltESP:AddPart(Part, Options)
    if not Part or not Part:IsA("BasePart") then return nil end
    return self:Add(Part, Options)
end

function CobaltESP:Remove(Target)
    local Object = self.Objects[Target]
    if Object then
        Object:Destroy()
        self.Objects[Target] = nil
    end
end

function CobaltESP:Clear()
    for Target, Object in pairs(self.Objects) do
        Object:Destroy()
    end
    self.Objects = {}
end

function CobaltESP:AddAllPlayers()
    for _, Player in pairs(Players:GetPlayers()) do
        if Player ~= LocalPlayer or self.Settings.LocalPlayer then
            self:Add(Player)
        end
    end
end

function CobaltESP:Start()
    self:AddAllPlayers()

    self.Connections.PlayerAdded = Players.PlayerAdded:Connect(function(Player)
        if Player ~= LocalPlayer or self.Settings.LocalPlayer then
            self:Add(Player)
        end
    end)

    self.Connections.PlayerRemoving = Players.PlayerRemoving:Connect(function(Player)
        self:Remove(Player)
    end)

    self.Connections.RenderStepped = RunService.RenderStepped:Connect(function()
        for _, Object in pairs(self.Objects) do
            Object:Update()
        end
    end)
end

function CobaltESP:Stop()
    for _, Connection in pairs(self.Connections) do
        if Connection then
            Connection:Disconnect()
        end
    end
    self.Connections = {}

    self:Clear()
end

function CobaltESP:Toggle(Enabled)
    self.Settings.Enabled = Enabled
end

return CobaltESP